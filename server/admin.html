<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡ºç´å¸³ DBç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #ffffff;
            color: #1a1a2e;
            padding: 20px;
        }
        h1 { margin-bottom: 20px; color: #1a1a2e; }
        h2 { margin: 20px 0 10px; color: #3b82f6; border-bottom: 1px solid #ddd; padding-bottom: 5px; }

        .stats {
            display: flex; gap: 20px; margin-bottom: 20px;
        }
        .stat-box {
            background: #f5f5f7;
            padding: 15px 25px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .stat-box .label { font-size: 12px; color: #666; }
        .stat-box .value { font-size: 24px; font-weight: bold; }
        .stat-box .value.green { color: #10b981; }
        .stat-box .value.red { color: #ef4444; }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #f5f5f7;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            color: #666;
            cursor: pointer;
            font-size: 14px;
        }
        .tab.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .panel { display: none; }
        .panel.active { display: block; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #f5f5f7;
            color: #666;
            position: sticky;
            top: 0;
        }
        tr:hover { background: rgba(59, 130, 246, 0.05); }

        .amount { font-weight: 600; }
        .amount.income { color: #10b981; }
        .amount.expense { color: #ef4444; }

        .balance { font-weight: 600; color: #3b82f6; }
        .balance.negative { color: #ef4444; }

        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-delete { background: #ef4444; color: white; }
        .btn-edit { background: #3b82f6; color: white; margin-right: 5px; }
        .btn-save { background: #10b981; color: white; }
        .btn-cancel { background: #666; color: white; margin-left: 5px; }

        .actions { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-action {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-refresh { background: #3b82f6; color: white; }
        .btn-cleanup { background: #f59e0b; color: white; }
        .btn-export { background: #10b981; color: white; }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal h3 { margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #666; font-size: 12px; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fff;
            color: #1a1a2e;
            font-size: 14px;
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        .filter-bar input, .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fff;
            color: #1a1a2e;
        }

        .duplicates-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .duplicates-warning h4 { color: #ef4444; margin-bottom: 10px; }

        .scroll-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .date-header {
            background: #f0f9ff;
            font-weight: 600;
            color: #1e40af;
        }
        .date-header td {
            padding: 8px 10px;
            border-bottom: 2px solid #3b82f6;
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š å‡ºç´å¸³ DBç®¡ç†</h1>

    <div class="stats" id="stats"></div>

    <div class="actions">
        <button class="btn-action btn-refresh" onclick="loadData()">ğŸ”„ æ›´æ–°</button>
        <button class="btn-action btn-cleanup" onclick="checkDuplicates()">ğŸ” é‡è¤‡ãƒã‚§ãƒƒã‚¯</button>
        <button class="btn-action btn-export" onclick="exportData()">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>

    <div id="duplicates-container"></div>

    <div class="tabs">
        <button class="tab active" data-panel="daily">ğŸ“… æ—¥åˆ¥è¨˜éŒ² (<span id="daily-count">0</span>)</button>
        <button class="tab" data-panel="transactions">ğŸ’° å–å¼•ä¸€è¦§ (<span id="tx-count">0</span>)</button>
    </div>

    <div id="daily-panel" class="panel active">
        <div class="filter-bar">
            <input type="text" id="daily-filter" placeholder="æ—¥ä»˜ã§æ¤œç´¢..." oninput="filterDaily()">
        </div>
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>æ—¥ä»˜</th>
                        <th>é–‹å§‹æ®‹é«˜</th>
                        <th>æ®‹é«˜è¨­å®š</th>
                        <th>ä½œæˆæ—¥æ™‚</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="daily-table"></tbody>
            </table>
        </div>
    </div>

    <div id="transactions-panel" class="panel">
        <div class="filter-bar">
            <input type="date" id="tx-date-filter" onchange="filterTransactions()">
            <select id="tx-type-filter" onchange="filterTransactions()">
                <option value="">ã™ã¹ã¦</option>
                <option value="income">å…¥é‡‘</option>
                <option value="expense">å‡ºé‡‘</option>
            </select>
            <input type="text" id="tx-search" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆæ¤œç´¢..." oninput="filterTransactions()">
        </div>
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>æ—¥ä»˜</th>
                        <th>æ™‚åˆ»</th>
                        <th>ç¨®åˆ¥</th>
                        <th>é‡‘é¡</th>
                        <th>å·®å¼•æ®‹é«˜</th>
                        <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
                        <th>ç”»åƒ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="tx-table"></tbody>
            </table>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <h3 id="modal-title">ç·¨é›†</h3>
            <div id="modal-form"></div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-save" onclick="saveEdit()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        let data = { dailyRecords: [], transactions: [] };
        let editingItem = null;
        let editingType = null;

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.panel + '-panel').classList.add('active');
            });
        });

        async function loadData() {
            try {
                const res = await fetch('/api/sync');
                data = await res.json();
                renderStats();
                renderDaily();
                renderTransactions();
                document.getElementById('daily-count').textContent = data.dailyRecords.length;
                document.getElementById('tx-count').textContent = data.transactions.length;
            } catch (err) {
                alert('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—: ' + err.message);
            }
        }

        function renderStats() {
            const totalIncome = data.transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = data.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('stats').innerHTML = `
                <div class="stat-box">
                    <div class="label">æ—¥æ•°</div>
                    <div class="value">${data.dailyRecords.length}</div>
                </div>
                <div class="stat-box">
                    <div class="label">å–å¼•æ•°</div>
                    <div class="value">${data.transactions.length}</div>
                </div>
                <div class="stat-box">
                    <div class="label">ç·å…¥é‡‘</div>
                    <div class="value green">Â¥${totalIncome.toLocaleString()}</div>
                </div>
                <div class="stat-box">
                    <div class="label">ç·å‡ºé‡‘</div>
                    <div class="value red">Â¥${totalExpense.toLocaleString()}</div>
                </div>
            `;
        }

        function renderDaily() {
            const filter = document.getElementById('daily-filter').value.toLowerCase();
            const filtered = data.dailyRecords.filter(r => r.date.includes(filter));

            document.getElementById('daily-table').innerHTML = filtered.map(r => `
                <tr data-date="${r.date}">
                    <td>${r.date}</td>
                    <td>Â¥${r.startingBalance.toLocaleString()}</td>
                    <td>${r.didSetStartingBalance ? 'âœ“' : '-'}</td>
                    <td>${new Date(r.createdAt).toLocaleString('ja-JP')}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editDaily('${r.date}')">ç·¨é›†</button>
                        <button class="btn btn-delete" onclick="deleteDaily('${r.date}')">å‰Šé™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderTransactions() {
            const dateFilter = document.getElementById('tx-date-filter').value;
            const typeFilter = document.getElementById('tx-type-filter').value;
            const searchFilter = document.getElementById('tx-search').value.toLowerCase();

            let filtered = data.transactions;
            if (dateFilter) filtered = filtered.filter(t => t.date === dateFilter);
            if (typeFilter) filtered = filtered.filter(t => t.type === typeFilter);
            if (searchFilter) filtered = filtered.filter(t => (t.comment || '').toLowerCase().includes(searchFilter));

            // Sort by date and time (oldest first for balance calculation)
            const sorted = [...filtered].sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return new Date(a.createdAt) - new Date(b.createdAt);
            });

            // Pre-calculate ending balance for each date
            const dateBalances = {};
            data.dailyRecords.forEach(r => {
                const dayTx = data.transactions.filter(t => t.date === r.date);
                let balance = r.startingBalance;
                dayTx.forEach(t => {
                    balance += t.type === 'income' ? t.amount : -t.amount;
                });
                dateBalances[r.date] = {
                    start: r.startingBalance,
                    end: balance
                };
            });

            // Calculate running balance per date
            let rows = [];
            let currentDate = null;
            let runningBalance = 0;

            sorted.forEach(t => {
                // Get starting balance for this date
                if (t.date !== currentDate) {
                    currentDate = t.date;
                    const balanceInfo = dateBalances[t.date] || { start: 0, end: 0 };
                    runningBalance = balanceInfo.start;

                    // Add date header row with start and end balance
                    rows.push(`
                        <tr class="date-header">
                            <td colspan="8">ğŸ“… ${t.date}ã€€ï½œã€€é–‹å§‹: Â¥${balanceInfo.start.toLocaleString()}ã€€â†’ã€€çµ‚äº†: <strong>Â¥${balanceInfo.end.toLocaleString()}</strong></td>
                        </tr>
                    `);
                }

                // Update running balance
                if (t.type === 'income') {
                    runningBalance += t.amount;
                } else {
                    runningBalance -= t.amount;
                }

                const time = new Date(t.createdAt).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                const balanceClass = runningBalance < 0 ? 'balance negative' : 'balance';

                rows.push(`
                    <tr data-id="${t.id}">
                        <td>${t.date}</td>
                        <td>${time}</td>
                        <td>${t.type === 'income' ? 'å…¥é‡‘' : 'å‡ºé‡‘'}</td>
                        <td class="amount ${t.type}">${t.type === 'income' ? '+' : '-'}Â¥${t.amount.toLocaleString()}</td>
                        <td class="${balanceClass}">Â¥${runningBalance.toLocaleString()}</td>
                        <td>${t.comment || '-'}</td>
                        <td>${t.imageData ? 'ğŸ“·' : '-'}</td>
                        <td>
                            <button class="btn btn-edit" onclick="editTransaction('${t.id}')">ç·¨é›†</button>
                            <button class="btn btn-delete" onclick="deleteTransaction('${t.id}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                `);
            });

            document.getElementById('tx-table').innerHTML = rows.join('');
        }

        function filterDaily() { renderDaily(); }
        function filterTransactions() { renderTransactions(); }

        function checkDuplicates() {
            const container = document.getElementById('duplicates-container');
            const issues = [];

            // Check duplicate dates in dailyRecords
            const dateCount = {};
            data.dailyRecords.forEach(r => {
                dateCount[r.date] = (dateCount[r.date] || 0) + 1;
            });
            const duplicateDates = Object.entries(dateCount).filter(([_, count]) => count > 1);
            if (duplicateDates.length > 0) {
                issues.push(`é‡è¤‡æ—¥ä»˜: ${duplicateDates.map(([d, c]) => `${d}(${c}ä»¶)`).join(', ')}`);
            }

            // Check duplicate transaction IDs
            const idCount = {};
            data.transactions.forEach(t => {
                idCount[t.id] = (idCount[t.id] || 0) + 1;
            });
            const duplicateIds = Object.entries(idCount).filter(([_, count]) => count > 1);
            if (duplicateIds.length > 0) {
                issues.push(`é‡è¤‡å–å¼•ID: ${duplicateIds.length}ä»¶`);
            }

            // Check transactions without matching daily record
            const validDates = new Set(data.dailyRecords.map(r => r.date));
            const orphanTx = data.transactions.filter(t => !validDates.has(t.date));
            if (orphanTx.length > 0) {
                issues.push(`å­¤ç«‹å–å¼•ï¼ˆæ—¥åˆ¥è¨˜éŒ²ãªã—ï¼‰: ${orphanTx.length}ä»¶`);
            }

            if (issues.length === 0) {
                container.innerHTML = '<div style="color: #10b981; margin-bottom: 20px;">âœ“ å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
            } else {
                container.innerHTML = `
                    <div class="duplicates-warning">
                        <h4>âš ï¸ å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</h4>
                        <ul>${issues.map(i => `<li>${i}</li>`).join('')}</ul>
                        <button class="btn btn-delete" onclick="autoCleanup()" style="margin-top: 10px;">è‡ªå‹•ä¿®å¾©</button>
                    </div>
                `;
            }
        }

        async function autoCleanup() {
            if (!confirm('é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆæœ€æ–°ã®ã‚‚ã®ã‚’æ®‹ã—ã¾ã™ï¼‰')) return;

            // Remove duplicate daily records (keep the one with latest createdAt)
            const seenDates = {};
            const cleanedDaily = [];
            data.dailyRecords.forEach(r => {
                if (!seenDates[r.date] || new Date(r.createdAt) > new Date(seenDates[r.date].createdAt)) {
                    seenDates[r.date] = r;
                }
            });
            data.dailyRecords = Object.values(seenDates);

            // Remove duplicate transactions
            const seenIds = {};
            data.transactions.forEach(t => {
                if (!seenIds[t.id] || new Date(t.createdAt) > new Date(seenIds[t.id].createdAt)) {
                    seenIds[t.id] = t;
                }
            });
            data.transactions = Object.values(seenIds);

            await saveToServer();
            loadData();
            checkDuplicates();
        }

        function editDaily(date) {
            const record = data.dailyRecords.find(r => r.date === date);
            editingItem = record;
            editingType = 'daily';
            document.getElementById('modal-title').textContent = 'æ—¥åˆ¥è¨˜éŒ²ã‚’ç·¨é›†';
            document.getElementById('modal-form').innerHTML = `
                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <input type="date" id="edit-date" value="${record.date}" readonly>
                </div>
                <div class="form-group">
                    <label>é–‹å§‹æ®‹é«˜</label>
                    <input type="number" id="edit-balance" value="${record.startingBalance}">
                </div>
                <div class="form-group">
                    <label>æ®‹é«˜è¨­å®š</label>
                    <select id="edit-didset">
                        <option value="true" ${record.didSetStartingBalance ? 'selected' : ''}>è¨­å®šã‚ã‚Š</option>
                        <option value="false" ${!record.didSetStartingBalance ? 'selected' : ''}>è¨­å®šãªã—</option>
                    </select>
                </div>
            `;
            document.getElementById('edit-modal').classList.add('show');
        }

        function editTransaction(id) {
            const tx = data.transactions.find(t => t.id === id);
            editingItem = tx;
            editingType = 'transaction';
            document.getElementById('modal-title').textContent = 'å–å¼•ã‚’ç·¨é›†';
            document.getElementById('modal-form').innerHTML = `
                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <input type="date" id="edit-date" value="${tx.date}">
                </div>
                <div class="form-group">
                    <label>ç¨®åˆ¥</label>
                    <select id="edit-type">
                        <option value="income" ${tx.type === 'income' ? 'selected' : ''}>å…¥é‡‘</option>
                        <option value="expense" ${tx.type === 'expense' ? 'selected' : ''}>å‡ºé‡‘</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é‡‘é¡</label>
                    <input type="number" id="edit-amount" value="${tx.amount}">
                </div>
                <div class="form-group">
                    <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                    <input type="text" id="edit-comment" value="${tx.comment || ''}">
                </div>
            `;
            document.getElementById('edit-modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.remove('show');
            editingItem = null;
            editingType = null;
        }

        async function saveEdit() {
            if (editingType === 'daily') {
                editingItem.startingBalance = parseInt(document.getElementById('edit-balance').value) || 0;
                editingItem.didSetStartingBalance = document.getElementById('edit-didset').value === 'true';
            } else if (editingType === 'transaction') {
                editingItem.date = document.getElementById('edit-date').value;
                editingItem.type = document.getElementById('edit-type').value;
                editingItem.amount = parseInt(document.getElementById('edit-amount').value) || 0;
                editingItem.comment = document.getElementById('edit-comment').value;
            }

            await saveToServer();
            closeModal();
            loadData();
        }

        async function deleteDaily(date) {
            if (!confirm(`${date} ã®æ—¥åˆ¥è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            data.dailyRecords = data.dailyRecords.filter(r => r.date !== date);
            await saveToServer();
            loadData();
        }

        async function deleteTransaction(id) {
            if (!confirm('ã“ã®å–å¼•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            data.transactions = data.transactions.filter(t => t.id !== id);
            await saveToServer();
            loadData();
        }

        async function saveToServer() {
            try {
                await fetch('/api/admin/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dailyRecords: data.dailyRecords,
                        transactions: data.transactions
                    })
                });
            } catch (err) {
                alert('ä¿å­˜å¤±æ•—: ' + err.message);
            }
        }

        function exportData() {
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `suito-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initial load
        loadData();
    </script>
</body>
</html>
